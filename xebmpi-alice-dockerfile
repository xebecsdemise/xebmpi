FROM alpine:3.9.3

MAINTAINER Xebec <xebecsdemise@outlook.com>

RUN apk update && apk upgrade \
  apk add sudo \
  apk add build-base \
  apk add sshd

RUN mkdir /tmp/mpich-build
WORKDIR /tmp/mpich-build
RUN wget http://www.mpich.org/static/downloads/3.3/mpich-3.3.tar.gz \
  && tar xfz mpich-3.3.tar.gz  \
  && cd mpich-3.3  \
  && ./configure \
  && make \
  && make install \
  && rm -rf /tmp/mpich-build

RUN mkdir -p /var/run/sshd && sed -i "s/UsePrivilegeSeparation.*/UsePrivilegeSeparation no/g" /etc/ssh/sshd_config \
  && echo "PermitRootLogin yes" >> /etc/ssh/sshd_config \
  && echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config \
  && echo "UsePAM no" >> /etc/ssh/sshd_config \
  && echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config \
  && touch /root/.Xauthority \
  && useradd -ms /bin/bash mpi \
  && echo "mpi   ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers \
  && mkdir /home/mpi/.ssh \
  && chown mpi:mpi /home/mpi/.ssh \
  && chmod 700 /home/mpi/.ssh \
  && echo "mpi:mpi" | chpasswd \
  && mkdir /swarm

COPY xebmpi-alice.sh /home/mpi/xebmpi-alice.sh
COPY buildmachinefile.sh /home/mpi/buildmachinefile.sh
RUN chown mpi:mpi /home/mpi/xebmpi-alice.sh \
  && chmod +x /home/mpi/xebmpi-alice.sh \
  && chown mpi:mpi /home/mpi/buildmachinefile.sh \
  && chmod +x /home/mpi/buildmachinefile.sh

EXPOSE 22

ENTRYPOINT ["/home/mpi/xebmpi-alice.sh"]

