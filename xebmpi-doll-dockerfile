FROM ubuntu:18.04

MAINTAINER Xebec <xebecsdemise@outlook.com>

RUN apt-get update && apt-get -y upgrade \
  && apt-get -y install --no-install-recommends \
  mpich \
  python-mpi4py \
  openssh-server \
  curl \
  nano

RUN mkdir -p /var/run/sshd && sed -i "s/UsePrivilegeSeparation.*/UsePrivilegeSeparation no/g" /etc/ssh/sshd_config \
  && echo "PermitRootLogin yes" >> /etc/ssh/sshd_config \
  && echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config \
  && echo "UsePAM no" >> /etc/ssh/sshd_config \
  && echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config \
  && touch /root/.Xauthority \
  && true

RUN useradd -ms /bin/bash mpi \
  && echo "mpi   ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers \
  && mkdir /home/mpi/.ssh \
  && chown mpi:mpi /home/mpi/.ssh \
  && chmod 700 /home/mpi/.ssh \
  && echo "mpi:mpi" | chpasswd 

RUN mkdir /swarm

COPY xebmpi-doll.sh /home/mpi/xebmpi-doll.sh
RUN chown mpi:mpi /home/mpi/xebmpi-doll.sh \
  && chmod +x /home/mpi/xebmpi-doll.sh

EXPOSE 22

ENTRYPOINT ["/home/mpi/xebmpi-doll.sh"]

